<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Ê∞¥ÁêÉÈÅäÊà≤</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #2c3e50;
            overflow: hidden;
        }
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        .start-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 40px;
            font-size: 24px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 32px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="game-canvas"></canvas>
    </div>

    <script>
        const GameState = {
            START: 'start',
            PLAYING: 'playing',
            END: 'end'
        };

        class Game {
            constructor() {
                this.state = GameState.START;
                this.engine = Matter.Engine.create();
                this.world = this.engine.world;
                this.canvas = document.getElementById('game-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.balls = [];
                
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                
                this.blueBox = {
                    body: Matter.Bodies.rectangle(100, 100, 100, 100, { isStatic: true }),
                    health: 1000
                };
                
                this.redBox = {
                    body: Matter.Bodies.rectangle(window.innerWidth - 150, window.innerHeight - 150, 100, 100, { isStatic: true }),
                    health: 100
                };

                Matter.World.add(this.world, [this.blueBox.body, this.redBox.body]);
                
                this.isDrawing = false;
                this.currentLine = [];
                this.setupMouseEvents();
                
                this.lastBallTime = 0;
                this.init();
            }

            init() {
                this.showStartButton();
                Matter.Engine.run(this.engine);
                this.update();
            }

            showStartButton() {
                const button = document.createElement('button');
                button.className = 'start-button';
                button.textContent = 'ÈñãÂßãÈÅäÊà≤';
                button.onclick = () => this.startGame();
                document.getElementById('game-container').appendChild(button);
            }

            startGame() {
                document.querySelector('.start-button')?.remove();
                this.state = GameState.PLAYING;
                this.blueBox.health = 1000;
                this.redBox.health = 100;
                this.balls = [];
                
                Matter.Events.on(this.engine, 'collisionStart', (event) => {
                    event.pairs.forEach((pair) => {
                        const isRedBox = pair.bodyA === this.redBox.body || pair.bodyB === this.redBox.body;
                        const ball = this.balls.find(b => b === pair.bodyA || b === pair.bodyB);
                        
                        if (isRedBox && ball) {
                            this.redBox.health--;
                            Matter.World.remove(this.world, ball);
                            this.balls = this.balls.filter(b => b !== ball);
                        }
                    });
                });
            }

            createBall() {
                if (this.blueBox.health <= 0) return;
                
                const ball = Matter.Bodies.circle(
                    this.blueBox.body.position.x,
                    this.blueBox.body.position.y,
                    5,
                    {
                        restitution: 0.8,
                        friction: 0.005
                    }
                );
                
                Matter.Body.setVelocity(ball, {
                    x: (Math.random() - 0.5) * 10,
                    y: (Math.random() - 0.5) * 10
                });
                
                this.balls.push(ball);
                Matter.World.add(this.world, ball);
                this.blueBox.health--;
            }

            showGameOver() {
                const div = document.createElement('div');
                div.className = 'game-over';
                if (this.blueBox.health <= 0) {
                    div.textContent = '‰Ω†Ëº∏‰∫ÜÔºÅ';
                } else {
                    div.textContent = `‰Ω†Ë¥è‰∫ÜÔºÅ\nÂàÜÊï∏Ôºö${this.blueBox.health}`;
                }
                document.getElementById('game-container').appendChild(div);
                
                setTimeout(() => {
                    div.remove();
                    this.state = GameState.START;
                    this.showStartButton();
                }, 5000);
            }

            setupMouseEvents() {
                this.canvas.addEventListener('mousedown', (e) => {
                    if (this.state === GameState.PLAYING) {
                        this.isDrawing = true;
                        this.currentLine = [{x: e.clientX, y: e.clientY}];
                    }
                });

                this.canvas.addEventListener('mousemove', (e) => {
                    if (this.isDrawing && this.state === GameState.PLAYING) {
                        this.currentLine.push({x: e.clientX, y: e.clientY});
                        
                        // Áï∂ÈªûÁöÑÊï∏ÈáèÈÅîÂà∞2ÂÄã‰ª•‰∏äÊôÇÔºåÂâµÂª∫Áâ©ÁêÜÁ∑öÊÆµ
                        if (this.currentLine.length >= 2) {
                            const p1 = this.currentLine[this.currentLine.length - 2];
                            const p2 = this.currentLine[this.currentLine.length - 1];
                            
                            // Ë®àÁÆóÁ∑öÊÆµÁöÑ‰∏≠ÈªûÂíåËßíÂ∫¶
                            const dx = p2.x - p1.x;
                            const dy = p2.y - p1.y;
                            const length = Math.sqrt(dx * dx + dy * dy);
                            const angle = Math.atan2(dy, dx);
                            const midX = (p1.x + p2.x) / 2;
                            const midY = (p1.y + p2.y) / 2;
                            
                            // ÂâµÂª∫ÈùúÊÖãÁ∑öÊÆµ
                            const segment = Matter.Bodies.rectangle(
                                midX,
                                midY,
                                length,
                                15,
                                {
                                    isStatic: true,
                                    angle: angle,
                                    render: {
                                        fillStyle: '#ffffff'
                                    }
                                }
                            );
                            
                            Matter.World.add(this.world, segment);
                        }
                    }
                });

                this.canvas.addEventListener('mouseup', () => {
                    this.isDrawing = false;
                    this.currentLine = [];
                });

                this.canvas.addEventListener('mouseleave', () => {
                    this.isDrawing = false;
                    this.currentLine = [];
                });
            }

            update() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                if (this.state === GameState.PLAYING) {
                    const currentTime = Date.now();
                    if (currentTime - this.lastBallTime > 33) { // Á¥ÑÊØèÁßí30È°ÜÁêÉ
                        this.createBall();
                        this.lastBallTime = currentTime;
                    }
                    
                    // Ê∏ÖÁêÜÂá∫ÁïåÁöÑÁêÉ
                    this.balls = this.balls.filter(ball => {
                        if (ball.position.y > this.canvas.height + 50 || 
                            ball.position.y < -50 ||
                            ball.position.x > this.canvas.width + 50 || 
                            ball.position.x < -50) {
                            Matter.World.remove(this.world, ball);
                            return false;
                        }
                        return true;
                    });
                    
                    // Áπ™Ë£ΩËóçËâ≤ÊñπÂ°äÊîπÁÇ∫emoji
                    this.ctx.font = '50px Arial';
                    this.ctx.fillText(
                        'üåä',  // Ê∞¥Ê≥¢emoji
                        this.blueBox.body.position.x - 25,
                        this.blueBox.body.position.y + 25
                    );
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '16px Arial';
                    this.ctx.fillText(
                        `ÁîüÂëΩ: ${this.blueBox.health}`,
                        this.blueBox.body.position.x - 40,
                        this.blueBox.body.position.y - 30
                    );
                    
                    // Áπ™Ë£ΩÁ¥ÖËâ≤ÊñπÂ°äÊîπÁÇ∫emoji
                    this.ctx.font = '50px Arial';
                    this.ctx.fillText(
                        'üéØ',  // ÁõÆÊ®ôemoji
                        this.redBox.body.position.x - 25,
                        this.redBox.body.position.y + 25
                    );
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '16px Arial';
                    this.ctx.fillText(
                        `ÁîüÂëΩ: ${this.redBox.health}`,
                        this.redBox.body.position.x - 40,
                        this.redBox.body.position.y - 30
                    );
                    
                    // Áπ™Ë£ΩÊâÄÊúâÁêÉÊîπÁÇ∫emoji
                    this.ctx.font = '15px Arial';
                    this.balls.forEach(ball => {
                        this.ctx.fillText(
                            'üíß',  // Ê∞¥Êª¥emoji
                            ball.position.x - 7,
                            ball.position.y + 7
                        );
                    });
                    
                    // Áπ™Ë£ΩÊâÄÊúâÁâ©ÁêÜÁâ©‰ª∂
                    const bodies = Matter.Composite.allBodies(this.world);
                    this.ctx.fillStyle = '#ffffff';
                    bodies.forEach(body => {
                        if (body !== this.blueBox.body && body !== this.redBox.body && !this.balls.includes(body)) {
                            const vertices = body.vertices;
                            this.ctx.beginPath();
                            this.ctx.moveTo(vertices[0].x, vertices[0].y);
                            for (let j = 1; j < vertices.length; j++) {
                                this.ctx.lineTo(vertices[j].x, vertices[j].y);
                            }
                            this.ctx.closePath();
                            this.ctx.fill();
                        }
                    });
                    
                    this.checkGameOver();
                }
                
                requestAnimationFrame(() => this.update());
            }

            checkGameOver() {
                if (this.blueBox.health <= 0 || this.redBox.health <= 0) {
                    this.state = GameState.END;
                    this.showGameOver();
                }
            }
        }

        window.onload = () => {
            new Game();
        };
    </script>
</body>
</html>

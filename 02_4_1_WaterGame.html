<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            overflow: hidden;
        }
        #gameCanvas {
            width: 100%;
            height: 100vh;
        }
        #startButton {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 40px;
            font-size: 24px;
            cursor: pointer;
            display: none;
        }
        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 36px;
            display: none;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="message"></div>
    <button id="startButton">開始遊戲</button>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script>
        const GameState = {
            START: 'start',
            PLAYING: 'playing',
            END: 'end'
        };

        let currentState = GameState.START;
        let engine, render, world;
        let blueBox, redBox;
        let blueHealth = 1000;
        let redHealth = 100;
        let isDrawing = false;
        let points = [];
        let ballSpawnInterval;

        // 將 emoji 轉換為圖片 URL
        function emojiToURL(emoji, size = 80) {
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            ctx.font = `${size}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(emoji, size/2, size/2);
            return canvas.toDataURL();
        }

        // 初始化物理引擎
        function init() {
            engine = Matter.Engine.create({
                gravity: { x: 0, y: 1 }
            });
            world = engine.world;

            render = Matter.Render.create({
                element: document.body,
                engine: engine,
                options: {
                    width: window.innerWidth,
                    height: window.innerHeight,
                    wireframes: false,
                    background: '#1a1a1a'
                }
            });

            Matter.Render.run(render);
            Matter.Runner.run(engine);
        }

        // 創建方塊
        function createBoxes() {
            const blueBoxTexture = emojiToURL('🏰');
            const redBoxTexture = emojiToURL('👾');

            blueBox = Matter.Bodies.rectangle(100, 100, 80, 80, {
                isStatic: true,
                render: {
                    sprite: {
                        texture: blueBoxTexture,
                        xScale: 1,
                        yScale: 1
                    }
                }
            });

            redBox = Matter.Bodies.rectangle(window.innerWidth - 100, window.innerHeight - 100, 80, 80, {
                isStatic: true,
                render: {
                    sprite: {
                        texture: redBoxTexture,
                        xScale: 1,
                        yScale: 1
                    }
                }
            });

            Matter.World.add(world, [blueBox, redBox]);
        }

        // 生成小球
        function spawnBall() {
            if (blueHealth <= 0) return;
            
            const ballTexture = emojiToURL('💧', 20);
            const ball = Matter.Bodies.circle(
                blueBox.position.x,
                blueBox.position.y,
                10,
                {
                    render: {
                        sprite: {
                            texture: ballTexture,
                            xScale: 1,
                            yScale: 1
                        }
                    }
                }
            );

            Matter.Body.setVelocity(ball, {
                x: (Math.random() - 0.5) * 10,
                y: 5
            });

            Matter.World.add(world, ball);
            blueHealth--;

            // 碰撞檢測
            Matter.Events.on(engine, 'collisionStart', (event) => {
                event.pairs.forEach((pair) => {
                    if ((pair.bodyA === ball && pair.bodyB === redBox) ||
                        (pair.bodyA === redBox && pair.bodyB === ball)) {
                        Matter.World.remove(world, ball);
                        redHealth--;
                        flashRedBox();
                    }
                });
            });
        }

        // 紅色方塊閃爍
        function flashRedBox() {
            const originalTexture = redBox.render.sprite.texture;
            redBox.render.sprite.texture = emojiToURL('💥');
            setTimeout(() => {
                redBox.render.sprite.texture = originalTexture;
            }, 100);
        }

        // 畫線
        function handleDrawing() {
            const canvas = render.canvas;
            let currentLine = null;

            canvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                points = [];
                points.push({ x: e.clientX, y: e.clientY });
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!isDrawing) return;
                points.push({ x: e.clientX, y: e.clientY });
                
                if (points.length >= 2) {
                    const startPoint = points[points.length - 2];
                    const endPoint = points[points.length - 1];
                    
                    const line = Matter.Bodies.rectangle(
                        (startPoint.x + endPoint.x) / 2,
                        (startPoint.y + endPoint.y) / 2,
                        Math.sqrt(Math.pow(endPoint.x - startPoint.x, 2) + Math.pow(endPoint.y - startPoint.y, 2)),
                        15,
                        {
                            isStatic: true,
                            angle: Math.atan2(endPoint.y - startPoint.y, endPoint.x - startPoint.x),
                            render: {
                                sprite: {
                                    texture: emojiToURL('🌟', 15),
                                    xScale: 1,
                                    yScale: 1
                                }
                            }
                        }
                    );
                    
                    Matter.World.add(world, line);
                }
            });

            canvas.addEventListener('mouseup', () => {
                isDrawing = false;
            });

            canvas.addEventListener('mouseleave', () => {
                isDrawing = false;
            });
        }

        // 狀態管理
        function setState(state) {
            currentState = state;
            switch (state) {
                case GameState.START:
                    document.getElementById('startButton').style.display = 'block';
                    document.getElementById('message').style.display = 'none';
                    resetGame();
                    break;
                case GameState.PLAYING:
                    document.getElementById('startButton').style.display = 'none';
                    ballSpawnInterval = setInterval(spawnBall, 100);
                    break;
                case GameState.END:
                    clearInterval(ballSpawnInterval);
                    const message = document.getElementById('message');
                    message.style.display = 'block';
                    if (blueHealth <= 0) {
                        message.innerHTML = '你輸了';
                    } else {
                        message.innerHTML = `你贏了<br>分數: ${blueHealth}`;
                    }
                    setTimeout(() => setState(GameState.START), 5000);
                    break;
            }
        }

        // 重置遊戲
        function resetGame() {
            Matter.World.clear(world);
            blueHealth = 1000;
            redHealth = 100;
            createBoxes();
        }

        // 遊戲循環
        function gameLoop() {
            if (currentState === GameState.PLAYING) {
                // 更新生命值顯示
                const ctx = render.context;
                ctx.font = '20px Arial';
                ctx.fillStyle = 'white';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // 藍色方塊生命值
                ctx.fillText(
                    blueHealth.toString(), 
                    blueBox.position.x, 
                    blueBox.position.y
                );
                
                // 紅色方塊生命值
                ctx.fillText(
                    redHealth.toString(), 
                    redBox.position.x, 
                    redBox.position.y
                );

                Matter.Body.setPosition(blueBox, { x: 100, y: 100 });
                Matter.Body.setPosition(redBox, { x: window.innerWidth - 100, y: window.innerHeight - 100 });

                // 檢查遊戲結束條件
                if (blueHealth <= 0 || redHealth <= 0) {
                    setState(GameState.END);
                }
            }
            requestAnimationFrame(gameLoop);
        }

        // 初始化遊戲
        init();
        handleDrawing();
        document.getElementById('startButton').addEventListener('click', () => setState(GameState.PLAYING));
        setState(GameState.START);
        gameLoop();
    </script>
</body>
</html>